<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Test Page</title>
    <link rel="stylesheet" href="app.css">
    <link rel="icon" href="data:,">
</head>
<body>
    <h1>API Test Page</h1>

    <!-- Form to create user -->
    <div class="container">
        <h2>User Management</h2>
        <div class="user-container">
            <div class="create-user-container">
                <form id="create-user-form">
                    <h3>Create User</h3>
                    <label for="username">Username:</label>
                    <input type="text" id="username" name="username" required>
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                    <label for="firstname">First Name:</label>
                    <input type="text" id="firstname" name="first_name" required>
                    <label for="lastname">Last Name:</label>
                    <input type="text" id="lastname" name="last_name" required>
                    <label for="password">Password:</label>
                    <input type="password" id="password" name="password" required>
                    <label for="phone">Phone:</label>
                    <input type="text" id="phone" name="phone">
                    <label for="address">Address:</label>
                    <input type="text" id="address" name="address">
                    <label for="city">City:</label>
                    <input type="text" id="city" name="city">
                    <label for="postal_code">Postal Code:</label>
                    <input type="text" id="postal_code" name="postal_code">
                    <label for="country">Country:</label>
                    <input type="text" id="country" name="country">
                    <div class="radio-group">
                        <label>User Status:</label>
                        <div class="radio-options">
                            <input type="radio" id="active-true" name="is_active" value="true" checked>
                            <label for="active-true">Active</label>
                            <input type="radio" id="active-false" name="is_active" value="false">
                            <label for="active-false">Inactive</label>
                        </div>
                    </div>
                    
                    <div class="radio-group">
                        <label>Admin Rights:</label>
                        <div class="radio-options">
                            <input type="radio" id="admin-true" name="is_admin" value="true">
                            <label for="admin-true">Admin</label>
                            <input type="radio" id="admin-false" name="is_admin" value="false" checked>
                            <label for="admin-false">Regular User</label>
                        </div>
                    </div>
                    <button type="submit">Create User</button>
                </form>
                <div id="create-user-form-message"></div>
            </div>
            <div class="update-user-container">  
                <form id="update-user-form">
                    <h3>Update User</h3>
                    <label for="update-user-id">User ID:</label>
                    <input type="text" id="update-user-id" name="id" required>
                    <label for="update-username">Username:</label>
                    <input type="text" id="update-username" name="username">
                    <label for="update-email">Email:</label>
                    <input type="email" id="update-email" name="email">
                    <label for="update-firstname">First Name:</label>
                    <input type="text" id="update-firstname" name="first_name">
                    <label for="update-lastname">Last Name:</label>
                    <input type="text" id="update-lastname" name="last_name">
                    <label for="update-password">Password:</label>
                    <input type="password" id="update-password" name="password">
                    <label for="update-phone">Phone:</label>
                    <input type="text" id="update-phone" name="phone">
                    <label for="address">Address:</label>
                    <input type="text" id="address" name="address">
                    <label for="city">City:</label>
                    <input type="text" id="city" name="city">
                    <label for="postal_code">Postal Code:</label>
                    <input type="text" id="postal_code" name="postal_code">
                    <label for="country">Country:</label>
                    <input type="text" id="country" name="country">
                    <div class="radio-group">
                        <label>User Status:</label>
                        <div class="radio-options">
                            <input type="radio" id="update-active-true" name="is_active" value="true">
                            <label for="update-active-true">Active</label>
                            <input type="radio" id="update-active-false" name="is_active" value="false">
                            <label for="update-active-false">Inactive</label>
                        </div>
                    </div>
                    
                    <div class="radio-group">
                        <label>Admin Rights:</label>
                        <div class="radio-options">
                            <input type="radio" id="update-admin-true" name="is_admin" value="true">
                            <label for="update-admin-true">Admin</label>
                            <input type="radio" id="update-admin-false" name="is_admin" value="false">
                            <label for="update-admin-false">Regular User</label>
                        </div>
                    </div>
                    <button type="submit">Update User</button>
                </form>
                <div id="update-user-form-message"></div>
            </div>
            <div class="delete-user-container">
                <form id="delete-user-form">
                    <h3>Delete User</h3>
                    <label for="delete-user-id">User ID:</label>
                    <input type="text" id="delete-user-id" name="id" required>
                    <button type="submit">Delete User</button>
                </form>
                <div id="delete-user-form-message"></div>
            </div>
            <div class="find-user-container">
                <form id="find-user-form">
                    <h3>Find User</h3>
                    <label for="find-user-id">User ID:</label>
                    <input type="text" id="find-user-id" name="id">
                    <label for="find-user-email">Email:</label>
                    <input type="email" id="find-user-email" name="email">
                    <label for="find-user-username">Username:</label>
                    <input type="text" id="find-user-username" name="username">
                    <label for="find-user-firstname">First Name:</label>
                    <input type="text" id="find-user-firstname" name="first_name">
                    <label for="find-user-lastname">Last Name:</label>
                    <input type="text" id="find-user-lastname" name="last_name">
                    <button type="submit">Find User</button>
                </form>
                <div id="find-user-form-message"></div>
            </div>
        </div>

    <button id="get-all-users">Get All Users</button>
    <div id="all-users-message"></div>

    <!-- Form to create place -->
    <h2>Place Management</h2>
    <div class="place-container">
        <div class="create-place-container">
            <h3>Create Place</h3>
            <form id="create-place-form">
                <label for="place-name">Place Name:</label>
                <input type="text" id="place-name" name="name" required>
                <label for="description">Description:</label>
                <textarea id="description" name="description" required></textarea>
                <label for="number-rooms">Number of Rooms:</label>
                <input type="number" id="number-rooms" name="number_rooms" required>
                <label for="number-bathrooms">Number of Bathrooms:</label>
                <input type="number" id="number-bathrooms" name="number_bathrooms" required>
                <label for="max-guest">Max Guests:</label>
                <input type="number" id="max-guest" name="max_guest" required>
                <label for="price-by-night">Price by Night:</label>
                <input type="number" step="any" id="price-by-night" name="price_by_night" required>
                <label for="latitude">Latitude:</label>
                <input type="number" step="any" id="latitude" name="latitude" required>
                <label for="longitude">Longitude:</label>
                <input type="number" step="any" id="longitude" name="longitude" required>
                <label for="owner-id">Owner ID:</label>
                <div class="owner-select-container">
                    <input type="text" id="owner-id" name="owner_id" required>
                    <button type="button" onclick="listUsers()">List Users</button>
                </div>
                <label for="property-type">Property Type:</label>
                <select id="property-type" name="property_type" required>
                    <option value="house">House</option>
                    <option value="apartment">Apartment</option>
                    <option value="guest_suite">Villa</option>
                </select>
                <button type="submit">Create Place</button>
            </form>
            <div id="create-place-form-message"></div>
        </div>
        <div class="update-place-container">
            <h3>Update Place</h3>
            <form id="update-place-form">
                <label for="update-place-id">Place ID:</label>
                <input type="text" id="update-place-id" name="id" required>
                <label for="update-place-name">Place Name:</label>
                <input type="text" id="update-place-name" name="name">
                <label for="update-description">Description:</label>
                <textarea id="update-description" name="description"></textarea>
                <label for="update-number-rooms">Number of Rooms:</label>
                <input type="number" id="update-number-rooms" name="number_rooms">
                <label for="update-number-bathrooms">Number of Bathrooms:</label>
                <input type="number" id="update-number-bathrooms" name="number_bathrooms">
                <label for="update-max-guest">Max Guests:</label>
                <input type="number" id="update-max-guest" name="max_guest">
                <label for="update-price-by-night">Price by Night:</label>
                <input type="number" step="any" id="update-price-by-night" name="price_by_night">
                <label for="update-latitude">Latitude:</label>
                <input type="number" step="any" id="update-latitude" name="latitude">
                <label for="update-longitude">Longitude:</label>
                <input type="number" step="any" id="update-longitude" name="longitude">
                <label for="update-owner-id">Owner ID:</label>
                <input type="text" id="update-owner-id" name="owner_id">
                <button type="submit">Update Place</button>
            </form>
            <div id="update-place-form-message"></div>
        </div>
        <div class="delete-place-container">
            <h3>Delete Place</h3>
            <form id="delete-place-form">
                <label for="delete-place-id">Place ID:</label>
                <input type="text" id="delete-place-id" name="id" required>
                <button type="submit">Delete Place</button>
            </form>
            <div id="delete-place-form-message"></div>
        </div>
    </div>
    <button id="get-all-places">Get All Places</button>
    <div id="all-places-message"></div>

    <!-- Form to create amenity -->
    <h2>Amenity Management</h2>
    <div class="amenity-container">
        <div class="create-amenity-container">
            <form id="create-amenity-form">
                <h3>Create Amenity</h3>
                <label for="amenity-name">Amenity Name:</label>
                <input type="text" id="amenity-name" name="name" required minlength="3">
                <label for="amenity-description">Description:</label>
                <textarea id="amenity-description" name="description" required minlength="10"></textarea>
                <label for="amenity-category">Category:</label>
                <select id="amenity-category" name="category" required>
                    <option value="safety">Safety</option>
                    <option value="comfort">Comfort</option>
                    <option value="entertainment">Entertainment</option>
                    <option value="supernatural">Supernatural</option>
                </select>
                <button type="submit">Create Amenity</button>
            </form>
            <div id="create-amenity-form-message"></div>
        </div>
        <div class="update-amenity-container">
            <form id="update-amenity-form">
                <h3>Update Amenity</h3>
                <label for="update-amenity-id">Amenity ID:</label>
                <input type="text" id="update-amenity-id" name="id" required>
                <label for="update-amenity-name">Amenity Name:</label>
                <input type="text" id="update-amenity-name" name="name">
                <button type="submit">Update Amenity</button>
            </form>
            <div id="update-amenity-form-message"></div>
        </div>
        <div class="delete-amenity-container">
            <form id="delete-amenity-form">
                <h3>Delete Amenity</h3>
                <label for="delete-amenity-id">Amenity ID:</label>
                <input type="text" id="delete-amenity-id" name="id" required>
                <button type="submit">Delete Amenity</button>
            </form>
            <div id="delete-amenity-form-message"></div>
        </div>
    </div>
    <button id="get-all-amenities">Get All Amenities</button>
    <div id="all-amenities-message"></div>

    <!-- Form to create review -->
    <h2>Create Review</h2>
    <form id="create-review-form">
        <label for="place-id">Place ID:</label>
        <input type="text" id="place-id" name="place_id" required>
        <label for="review-text">Review:</label>
        <textarea id="review-text" name="text" required minlength="10"></textarea>
        <label for="review-text">Review:</label>
        <textarea id="review-text" name="review-text" required></textarea>
        <label for="rating">Rating:</label>
        <input type="number" id="rating" name="rating" min="0" max="5" required>
        <button type="submit">Create Review</button>
    </form>
    <div id="create-review-form-message"></div>
    <button id="get-all-reviews">Get All Reviews</button>
    <div id="all-reviews-message"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        async function listUsers() {
            try {
                const response = await fetch('http://localhost:5000/api/v1/users');
                if (!response.ok) {
                    throw new Error('Failed to fetch users');
                }
                const users = await response.json();
                const usersList = document.getElementById('users-list');
                usersList.innerHTML = '<h4>Available Users:</h4>';
                users.forEach(user => {
                    usersList.innerHTML += `
                        <div class="user-item">
                            <strong>ID:</strong> ${user.id}<br>
                            <strong>Name:</strong> ${user.first_name} ${user.last_name}<br>
                            <button onclick="selectUser('${user.id}')">Select</button>
                        </div>
                    `;
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function selectUser(userId) {
            document.getElementById('owner-id').value = userId;
        }
        function handleFormSubmit(formId, apiEndpoint, method = 'POST') {
        const form = document.getElementById(formId);
        if (!form) {
            console.error(`Form with id "${formId}" not found`);
            return;
        }

        // const messageElement = document.getElementById(`${formId.replace('-form', '')}-message`);
        // if (!messageElement) {
        //     console.error(`Message element for form "${formId}" not found`);
        //     return;
        // }

        form.addEventListener('submit', async function(event) {
            event.preventDefault();
            try {
                let url = apiEndpoint;
                let idToDelete;
                let options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' }
                };

                if (method === 'GET') {
                    // Construire l'URL avec les paramètres de recherche
                    const formData = new FormData(form);
                    const params = new URLSearchParams();
                    
                    // N'ajouter que les paramètres qui ont une valeur
                    for (const [key, value] of formData.entries()) {
                        if (value) {
                            params.append(key, value);
                        }
                    }
                    
                    // Ajouter les paramètres à l'URL
                    const queryString = params.toString();
                    url = queryString ? `${apiEndpoint}?${queryString}` : apiEndpoint;
                    
                    // Pas besoin de body pour une requête GET
                    delete options.body;
                } else if (method !== 'DELETE') {
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    // Conversion des booléens pour les formulaires utilisateur
                    if (formId === 'create-user-form' || formId === 'update-user-form') {
                        if (data.hasOwnProperty('is_active')) {
                            data.is_active = data.is_active === 'true';
                        }
                        if (data.hasOwnProperty('is_admin')) {
                            data.is_admin = data.is_admin === 'true';
                        }
                    }

                    // Vérifier d'abord que l'owner existe
                    if (data.owner_id) {
                        try {
                            const ownerResponse = await fetch(`${apiEndpoint.replace('places', 'users')}/${data.owner_id}`);
                            if (!ownerResponse.ok) {
                                throw new Error('Invalid owner_id: User not found');
                            }
                        } catch (error) {
                            throw new Error('Invalid owner_id: User not found');
                        }
                    }

                    if (formId === 'create-place-form' || formId === 'update-place-form') {
                        ['latitude', 'longitude', 'price_by_night'].forEach(field => {
                            if (data[field]) {
                                data[field] = parseFloat(data[field]);
                                if (isNaN(data[field])) {
                                    throw new Error(`Invalid parameter: ${field} must be of type float`);
                                }
                            }
                        });

                        ['number_rooms', 'number_bathrooms', 'max_guest'].forEach(field => {
                            if (data[field]) {
                                data[field] = parseInt(data[field], 10);
                                if (isNaN(data[field])) {
                                    throw new Error(`Invalid parameter: ${field} must be of type integer`);
                                }
                            }
                        });
                    }

                    if (method !== 'POST') {
                        const id = data.id;
                        if (!id) {
                            throw new Error('ID is required for update and delete operations');
                        }
                        url = `${apiEndpoint}/${id}`.replace(/([^:]\/)\/+/g, "$1");
                        delete data.id;
                    }
                    options.body = JSON.stringify(data);
                } else {
                    const idInput = form.querySelector('input[name="id"]');
                    if (!idInput || !idInput.value) {
                        throw new Error('ID is required for delete operation');
                    }
                    idToDelete = idInput.value;
                    url = `${apiEndpoint}/${idToDelete}`.replace(/([^:]\/)\/+/g, "$1");
                }

                displayResult(formId, { message: 'Processing...' });

                const response = await fetch(url, options);

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status} ${errorText}`);
                }

                if (method === 'DELETE' && response.status === 204) {
                    displayResult(formId, { message: 'Successfully deleted' });
                } else {
                    const result = await response.json().catch(() => ({ message: 'Operation successful' }));
                    displayResult(formId, result);
                }
            } catch (error) {
                displayResult(formId, { error: error.message });
            }
        });
    }

        function handleGetAllButton(buttonId, apiEndpoint) {
            const button = document.getElementById(buttonId);
            if (!button) {
                console.error(`Button with id "${buttonId}" not found`);
                return;
            }
            
            button.addEventListener('click', async function() {
                try {
                    const response = await fetch(apiEndpoint);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
        
                    const result = await response.json();
                    displayResult(buttonId, result);
                } catch (error) {
                    displayResult(buttonId, { error: error.message });
                }
            });
        }

        function displayResult(elementId, result) {
            // Ajuste l'ID pour correspondre à celui dans le HTML
            const messageId = elementId.startsWith('get-') ? elementId.replace('get-', '') : elementId;
            const messageElement = document.getElementById(`${messageId}-message`);
            const FormmessageElement = document.getElementById(`${elementId}form-message`);
            if (messageElement) {
                if (Array.isArray(result)) {
                    const table = document.createElement('table');
                    const thead = document.createElement('thead');
                    const tbody = document.createElement('tbody');
        
                    // Create table headers
                    const headers = Object.keys(result[0]);
                    const headerRow = document.createElement('tr');
                    headers.forEach(header => {
                        const th = document.createElement('th');
                        th.textContent = header;
                        headerRow.appendChild(th);
                    });
                    thead.appendChild(headerRow);
        
                    // Create table rows
                    result.forEach(item => {
                        const row = document.createElement('tr');
                        headers.forEach(header => {
                            const td = document.createElement('td');
                            td.textContent = item[header];
                            row.appendChild(td);
                        });
                        tbody.appendChild(row);
                    });
        
                    table.appendChild(thead);
                    table.appendChild(tbody);
                    messageElement.innerHTML = '';
                    messageElement.appendChild(table);
                } else {
                    messageElement.textContent = JSON.stringify(result, null, 2);
                }
            } else {
                console.error(`Element with id "${messageId}-message" not found`);
            }
        }

        // Configuration des formulaires
        handleFormSubmit('create-user-form', 'http://localhost:5000/api/v1/users/', 'POST');
        handleFormSubmit('update-user-form', 'http://localhost:5000/api/v1/users/', 'PUT');
        handleFormSubmit('delete-user-form', 'http://localhost:5000/api/v1/users/', 'DELETE');
        handleFormSubmit('find-user-form', 'http://localhost:5000/api/v1/users/', 'GET');
        handleFormSubmit('create-place-form', 'http://localhost:5000/api/v1/places/', 'POST');
        handleFormSubmit('update-place-form', 'http://localhost:5000/api/v1/places/', 'PUT');
        handleFormSubmit('delete-place-form', 'http://localhost:5000/api/v1/places/', 'DELETE');
        handleFormSubmit('create-amenity-form', 'http://localhost:5000/api/v1/amenities/', 'POST');
        handleFormSubmit('update-amenity-form', 'http://localhost:5000/api/v1/amenities/', 'PUT');
        handleFormSubmit('delete-amenity-form', 'http://localhost:5000/api/v1/amenities/', 'DELETE');
        handleFormSubmit('create-review-form', 'http://localhost:5000/api/v1/reviews/', 'POST');


        // Configuration des boutons "Get All"
        handleGetAllButton('get-all-users', 'http://localhost:5000/api/v1/users/');
        handleGetAllButton('get-all-places', 'http://localhost:5000/api/v1/places/');
        handleGetAllButton('get-all-amenities', 'http://localhost:5000/api/v1/amenities/');
        handleGetAllButton('get-all-reviews', 'http://localhost:5000/api/v1/reviews/');
});
    </script>
</body>
</html>